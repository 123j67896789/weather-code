<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Radar + Forecast Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
/* General */
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: #0a0a0a;
  color: #fff;
  overflow: hidden;
}
#map {
  position: absolute;
  inset: 0;
}

/* Sidebar */
.sidebar {
  position: absolute;
  top: 24px;
  left: 24px;
  width: 360px;
  background: rgba(15,15,15,0.85);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.7);
  z-index: 1000;
  transition: width 0.3s ease;
}
.sidebar h1 {
  font-size: 16px;
  letter-spacing: 0.12em;
  margin-bottom: 20px;
  color: #eee;
}
.control {
  margin-bottom: 18px;
}
label {
  display: block;
  font-size: 12px;
  color: #bbb;
  margin-bottom: 6px;
}
.select, input[type=range] {
  width: 100%;
}
.select {
  background: rgba(30,30,30,0.9);
  color: #fff;
  border: none;
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.2s;
}
.select:hover {
  background: rgba(50,50,50,0.95);
}
input[type=range] {
  -webkit-appearance: none;
  height: 6px;
  border-radius: 3px;
  background: #444;
  cursor: pointer;
  transition: background 0.2s;
}
input[type=range]:hover {
  background: #666;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #00bfff;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
  transition: background 0.2s;
}
input[type=range]::-moz-range-thumb {
  width: 14px;
  height: 14px;
  background: #00bfff;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
  border: none;
}
#forecastControl { display: none; }
#forecastTime {
  font-size: 11px;
  color: #999;
  margin-top: 6px;
  text-align: center;
}
#errorMsg {
  color: #ff5555;
  font-size: 12px;
  margin-top: 10px;
  display: none;
}
.info {
  font-size: 11px;
  color: #aaa;
  margin-top: 12px;
  text-align: center;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="sidebar">
<h1>NATIONAL RADAR & FORECAST</h1>

<div class="control">
<label>Product</label>
<select id="product" class="select">
<option value="reflectivity">Observed: Base Reflectivity</option>
<option value="wind_speed">Observed: Surface Wind Speed</option>
<option value="satellite_vis">Satellite Visible</option>
<option value="forecast_hrrr_refp">HRRR: Reflectivity + Precip</option>
<option value="forecast_hrrr_refd">HRRR: Reflectivity Only</option>
<option value="ndfd_tmin">NOAA Forecast: Min Temp</option>
<option value="ndfd_tmax">NOAA Forecast: Max Temp</option>
<option value="ndfd_pop12">NOAA Forecast: Precip Probability</option>
<option value="ndfd_qpf">NOAA Forecast: Quantitative Precip</option>
<option value="ndfd_wspd">NOAA Forecast: Wind Speed</option>
</select>
</div>

<div class="control" id="forecastControl">
<label>Forecast Hour</label>
<input id="forecastSlider" type="range" min="0" max="18" step="1" value="0"/>
<div id="forecastTime">Forecast Hour: +0 hr</div>
</div>

<div class="control">
<label>Opacity</label>
<input id="opacity" type="range" min="0" max="1" step="0.05" value="0.85"/>
</div>

<div id="errorMsg">Tiles not loading – try refresh or wait</div>
<div class="info">National radar, satellite, HRRR/NDFD forecast layers • IEM / NOAA / NWS</div>
</div>

<script>
// Leaflet map setup
const map = L.map('map',{center:[36.19,-94.13],zoom:8,zoomControl:false});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19}).addTo(map);

let radarLayer=null;
const productSelect=document.getElementById('product');
const forecastSlider=document.getElementById('forecastSlider');
const forecastTime=document.getElementById('forecastTime');
const forecastControl=document.getElementById('forecastControl');
const opacityControl=document.getElementById('opacity');
const errorMsg=document.getElementById('errorMsg');

function getHRRRSuffix(){return productSelect.value==='forecast_hrrr_refp'?'REFP':'REFD';}

function loadProduct(){
  if(radarLayer) map.removeLayer(radarLayer);
  errorMsg.style.display='none';
  const ts = Date.now();
  const p = productSelect.value;

  // Show slider only for forecast layers
  if(p.startsWith('forecast_') || p.startsWith('ndfd')) forecastControl.style.display='block';
  else forecastControl.style.display='none';

  // OBSERVED / SATELLITE
  if(['reflectivity','wind_speed','satellite_vis'].includes(p)){
    let url='';
    switch(p){
      case 'reflectivity': url='https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q/{z}/{x}/{y}.png?t='+ts; break;
      case 'wind_speed': url='https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/mrms::WIND-0/{z}/{x}/{y}.png?t='+ts; break;
      case 'satellite_vis': url='https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/goes-vis-1km/{z}/{x}/{y}.png?t='+ts; break;
    }
    radarLayer=L.tileLayer(url,{opacity:opacityControl.value,maxZoom:19}).addTo(map);
  }

  // HRRR forecast
  else if(p.startsWith('forecast_hrrr')){
    let hour=Math.min(parseInt(forecastSlider.value),18);
    const fStr=String(hour*60).padStart(4,'0');
    const suffix=getHRRRSuffix();
    const url=`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/hrrr::${suffix}-F${fStr}-0/{z}/{x}/{y}.png?t=${ts}`;
    radarLayer=L.tileLayer(url,{opacity:opacityControl.value,maxZoom:19}).addTo(map);
    forecastTime.textContent=`Forecast Hour: +${hour} hr (${suffix})`;
  }

  // NDFD forecast
  else if(p.startsWith('ndfd')){
    let hour=parseInt(forecastSlider.value);
    const ndfdBase='https://digital.weather.gov/ndfd/conus/wms';
    let layerName='';
    switch(p){
      case 'ndfd_tmin': layerName='ndfd.conus.tmin'; break;
      case 'ndfd_tmax': layerName='ndfd.conus.tmax'; break;
      case 'ndfd_pop12': layerName='ndfd.conus.pop12'; break;
      case 'ndfd_qpf': layerName='ndfd.conus.qpf'; break;
      case 'ndfd_wspd': layerName='ndfd.conus.wspd'; break;
    }
    const forecastDate=new Date();
    forecastDate.setUTCHours(forecastDate.getUTCHours()+hour);
    const isoTime=forecastDate.toISOString();
    radarLayer=L.tileLayer.wms(ndfdBase,{
      layers:layerName,
      format:'image/png',
      transparent:true,
      opacity:opacityControl.value,
      time:isoTime
    }).addTo(map);
    forecastTime.textContent=`Forecast Hour: +${hour} hr`;
  }

  radarLayer.on('tileerror',()=>{ errorMsg.style.display='block'; });
}

// Event listeners
productSelect.addEventListener('change',loadProduct);
forecastSlider.addEventListener('input',loadProduct);
opacityControl.addEventListener('input',()=>{if(radarLayer) radarLayer.setOpacity(opacityControl.value);});

// Auto-refresh observed layers
setInterval(()=>{
  if(radarLayer && !productSelect.value.startsWith('forecast_') && !productSelect.value.startsWith('ndfd')){
    const newTs=Date.now();
    const baseUrl=radarLayer.getTileUrl({z:0,x:0,y:0}).split('?')[0];
    radarLayer.setUrl(baseUrl+'?t='+newTs);
  }
},5*60*1000);

loadProduct();
</script>
</body>
</html>

